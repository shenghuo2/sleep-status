<!DOCTYPE html>
<html lang="zh-CN" class="dark:bg-gray-900">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading...</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'media',
    }
  </script>
  <style>
    .status-sleeping { color: #3498db; }
    .status-awake { color: #2ecc71; }
    .status-error { color: #e74c3c; }
    @media (prefers-color-scheme: dark) {
      .status-sleeping { color: #60a5fa; }
      .status-awake { color: #34d399; }
      .status-error { color: #f87171; }
    }
    .offline-mode {
      transition: all 0.5s ease;
      filter: grayscale(70%) brightness(85%);
    }
    .floating-candle {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      font-size: 2rem;
      filter: drop-shadow(0 0 10px rgba(255, 200, 100, 0.3));
      transition: transform 0.3s ease-out;
    }
    .candle-flame {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      animation: flicker 1s ease-in-out infinite alternate;
      color: #ffd700;
      text-shadow: 0 0 10px #ff6b00,
                   0 0 20px #ff6b00,
                   0 0 30px #ff8800;
    }

    @keyframes flicker {
      0%, 100% {
        transform: translateX(-50%) scale(1.1);
        text-shadow: 0 0 10px #ff6b00,
                     0 0 20px #ff6b00,
                     0 0 30px #ff8800;
      }
      50% {
        transform: translateX(-50%) scale(0.9);
        text-shadow: 0 0 5px #ff6b00,
                     0 0 10px #ff6b00,
                     0 0 15px #ff8800;
      }

    }
    .offline-mode::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background:
        radial-gradient(circle at 50% 50%, rgba(0,0,0,0.3) 0%, transparent 80%),
        linear-gradient(0deg, rgba(0,0,0,0.2) 0%, transparent 100%);
      pointer-events: none;

      z-index: 999;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900" id="mainBody">
  <div id="candleContainer"></div>
  <div class="max-w-2xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-gray-900 dark:text-white"><span id='my-name'>我</span><ruby>似<rt>sǐ</rt></ruby>了吗?</h1>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6 transition-shadow duration-300 hover:shadow-xl">
      <div class="text-gray-700 dark:text-gray-300" id="my-status">Loading...</div>
      <div id="status" class="text-2xl my-3">加载中...</div>
      <div id="description" class="text-gray-600 dark:text-gray-400"></div>
      <div class="text-sm text-gray-500 dark:text-gray-400 mt-4">最后更新: <span id="updateTime"></span></div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6 transition-shadow duration-300 hover:shadow-xl">
      <div id="timelineTitle" class="text-gray-700 dark:text-gray-300 mb-4">离线记录:</div>
      <div id="sleepTimelines" class="space-y-8"></div>
      <div id="timelineDescription" class="text-sm text-gray-500 dark:text-gray-400 mt-8"></div>
      <div id="weeklyStats" class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
        <div id="statsTitle" class="text-gray-700 dark:text-gray-300 mb-4">睡眠统计:</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <div class="text-sm text-gray-600 dark:text-gray-400">平均入睡时间: <span id="avgSleepTime" class="font-mono">--:--</span></div>
            <div class="text-sm text-gray-600 dark:text-gray-400">平均清醒时间: <span id="avgWakeTime" class="font-mono">--:--</span></div>
          </div>
          <div class="space-y-2">
            <div class="text-sm text-gray-600 dark:text-gray-400">每日平均睡眠时长: <span id="avgSleepDuration" class="font-mono">-小时-分钟</span></div>
            <div class="text-sm text-gray-600 dark:text-gray-400">统计周期: <span id="statsDateRange" class="font-mono">----/--/-- ~ ----/--/--</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-col space-y-4">

      <div class="flex justify-between items-center">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          你可以通过这个页面 👀 <span id='my-name1'>我</span>
          <br>
        联系方式 <a href="https://www.google.com" id='contact-me' class="text-blue-500 hover:underline" target="_blank">点我</a>

        </div>
      </div>
      <div class="text-xs text-gray-500 dark:text-gray-400 border-t pt-4 mt-4">
        本项目展示 <a href="https://www.google.com" class="text-blue-500 hover:underline" target="_blank" id="my-github"><span id='my-name2'>我</span></a> 的<span id='info-from'></span>
        <br>
        项目开源于 <a href="https://github.com/shenghuo2/sleep-status" class="text-blue-500 hover:underline" target="_blank">Github</a>
        <br>
        前端开源于 <a href="https://github.com/shenghuo2/sleep-status/tree/feature/example-frontend" class="text-blue-500 hover:underline" target="_blank">feature/example-fronend</a> 分支
      </div>

    </div>

    <script>
	  // =================== 配置 ===================
	  const MY_NAME = "shenghuo2";
	  const API_URL = "https://sleep-status.shenghuo2.top";
	  const MY_GITHUB_URL = "https://github.com/shenghuo2";
	  const CONTACT_URL = "https://github.com/shenghuo2";
	  const INFO_FROM = "Xiaomi 14 设备在线状态，并通过Magisk 模块实时采集并上传。";
	  // =================== 配置 ===================
	  
	  // Init
	  document.title = MY_NAME + '现在似了吗?';
	  
	  document.getElementById('my-status').textContent = MY_NAME + "'s Status:";
	  document.getElementById('my-name').textContent = MY_NAME;
	  document.getElementById('my-name1').textContent = MY_NAME;
	  document.getElementById('my-name2').textContent = MY_NAME;
	  document.getElementById('my-github').href = MY_GITHUB_URL;
	  document.getElementById('info-from').textContent = INFO_FROM;
	  document.getElementById('contact-me').href = CONTACT_URL;
	  
	  
      function formatTime(hours) {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      }
      
      function formatDuration(hours) {
            const h = Math.floor(hours);
            const m = Math.round((hours - h) * 60);
      
            if (h === 0) {
                  return `${m}m`;
            } else {
                  return `${h}h${m > 0 ? m + 'm' : ''}`;
            }
      }
      
      function updateTime() {
            const now = new Date();
      
            return now.getFullYear() + '-' +
                  String(now.getMonth() + 1).padStart(2, '0') + '-' +
                  String(now.getDate()).padStart(2, '0') + ' ' +
                  String(now.getHours()).padStart(2, '0') + ':' +
                  String(now.getMinutes()).padStart(2, '0') + ':' +
                  String(now.getSeconds()).padStart(2, '0');
      }
      
      function createTimelineElement(date, segments) {
            const container = document.createElement('div');
            container.className = 'mb-8 last:mb-0';
      
            const dateLabel = document.createElement('div');
            dateLabel.className = 'text-sm text-gray-600 dark:text-gray-400 mb-2';
            dateLabel.textContent = date;
            container.appendChild(dateLabel);
      
            const timelineWrapper = document.createElement('div');
            timelineWrapper.className = 'relative';
            container.appendChild(timelineWrapper);
      
      
            // 时间线和刻度线
            const timelineContainer = document.createElement('div');
            timelineContainer.className = 'relative h-6 bg-gray-100 dark:bg-gray-700 rounded-md overflow-hidden';
            timelineWrapper.appendChild(timelineContainer);
      
            // 添加刻度线
      
            for (let hour = 0; hour <= 24; hour += 3) {
                  const tick = document.createElement('div');
                  tick.className = 'absolute top-0 bottom-0 w-px bg-gray-300 dark:bg-gray-600 z-10';
                  tick.style.left = `${(hour / 24) * 100}%`;
      
      
                  // 主要刻度线加粗
                  if (hour % 6 === 0) {
                        tick.classList.add('bg-gray-400', 'dark:bg-gray-500');
                  }
      
                  timelineContainer.appendChild(tick);
            }
      
            // 添加时间刻度
            const timeMarkers = document.createElement('div');
            timeMarkers.className = 'flex justify-between text-xs text-gray-400 dark:text-gray-500 mt-1';
      
      
            // 添加6小时间隔的刻度
            for (let hour = 0; hour <= 24; hour += 6) {
                  const marker = document.createElement('div');
                  marker.className = 'relative';
                  marker.style.width = '1px'; // 仅用于定位
      
                  // 刻度文本
                  const text = document.createElement('div');
                  text.className = 'absolute transform -translate-x-1/2';
                  text.textContent = hour === 0 || hour === 24 ? hour : hour;
                  marker.appendChild(text);
      
                  timeMarkers.appendChild(marker);
            }
      
            timelineWrapper.appendChild(timeMarkers);
      
            segments.forEach(segment => {
                  const segmentElement = document.createElement('div');
                  segmentElement.className =
                        'absolute h-full bg-blue-200 dark:bg-blue-800 flex items-center justify-center ' +
                        'text-xs text-gray-600 dark:text-gray-300 transition-all duration-300 z-20';
                  segmentElement.style.left = segment.start + '%';
                  segmentElement.style.width = (segment.end - segment.start) + '%';
      
                  const timeText = document.createElement('div');
                  timeText.className = 'px-2 whitespace-nowrap';
                  timeText.textContent = segment.text;
                  segmentElement.appendChild(timeText);
      
      
                  timelineContainer.appendChild(segmentElement);
            });
      
            return container;
      }
      
      function getDatesBetween(startUTC, endUTC) {
            const start = new Date(startUTC.getTime() + 8 * 60 * 60 * 1000);
            start.setUTCHours(0, 0, 0, 0);
      
            const end = new Date(endUTC.getTime() + 8 * 60 * 60 * 1000);
            end.setUTCHours(23, 59, 59, 999);
      
            const dates = [];
            let current = new Date(start);
      
            while (current <= end) {
                  dates.push(new Date(current));
                  current = new Date(current.getTime() + 24 * 60 * 60 * 1000);
            }
            return dates;
      }
      
      function toLocalISODateString(utcTime) {
            const date = new Date(utcTime);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
      }
      
      
      
      function calculateSleepSegments(records) {
      
            const sleepSegments = {};
      
            const sortedRecords = [...records].sort((a, b) =>
      
                  new Date(a.time) - new Date(b.time)
            );
      
            let currentSleep = null;
      
            sortedRecords.forEach((record) => {
                  const date = new Date(record.time);
                  const localDateStr = toUTC8DateString(record.time);
      
                  // 转换为UTC+8时间
                  const utc8Date = new Date(date.getTime() + 8 * 60 * 60 * 1000);
                  const hours = utc8Date.getUTCHours() + utc8Date.getUTCMinutes() / 60;
      
                  if (record.action === 'sleep') {
                        currentSleep = {
                              start: date,
                              startHours: hours,
                              startDate: localDateStr
                        };
                  } else if (record.action === 'wake' && currentSleep) {
                        const endDate = new Date(record.time);
                        const endUtc8Date = new Date(endDate.getTime() + 8 * 60 * 60 * 1000);
                        const endHours = endUtc8Date.getUTCHours() + endUtc8Date.getUTCMinutes() / 60;
      
                        const datesBetween = getDatesBetween(
                              new Date(currentSleep.start),
                              new Date(endDate)
                        );
      
                        datesBetween.forEach((dateObj, i) => {
                              const dateKey = dateObj.toISOString().substring(0, 10);
                              if (!sleepSegments[dateKey]) sleepSegments[dateKey] = [];
      
                              const segmentStart = i === 0 ? currentSleep.startHours : 0;
                              const segmentEnd = i === datesBetween.length - 1 ? endHours : 24;
      
                              sleepSegments[dateKey].push({
                                    start: segmentStart,
                                    end: segmentEnd,
                                    text: `${formatTime(segmentStart)}-${formatTime(segmentEnd)} ` +
                                          `(${formatDuration(segmentEnd - segmentStart)})`
                              });
                        });
      
                        currentSleep = null;
                  }
            });
      
            // 处理未结束的睡眠
            if (currentSleep) {
                  const now = new Date();
                  const datesBetween = getDatesBetween(currentSleep.start, now);
      
                  datesBetween.forEach((dateObj, i) => {
                        const dateKey = dateObj.toISOString().substring(0, 10);
                        if (!sleepSegments[dateKey]) sleepSegments[dateKey] = [];
      
                        const segmentStart = i === 0 ? currentSleep.startHours : 0;
                        const segmentEnd = i === datesBetween.length - 1 ?
                              (now.getHours() + now.getMinutes() / 60) : 24;
      
      
                        sleepSegments[dateKey].push({
      
                              start: segmentStart,
                              end: segmentEnd,
                              text: `${formatTime(segmentStart)}-${formatTime(segmentEnd)} ` +
                                    `(${formatDuration(segmentEnd - segmentStart)})`
                        });
                  });
            }
      
            return sleepSegments;
      }
      
      
      function createFloatingElements(sleep) {
            const candleContainer = document.getElementById('candleContainer');
      
            let candleAnimationFrame;
      
            // 清除现有的元素和动画
            candleContainer.innerHTML = '';
      
            if (candleAnimationFrame) {
                  cancelAnimationFrame(candleAnimationFrame);
            }
      
            if (sleep) {
                  // 创建蜡烛
      
                  const candles = [];
                  const candleCount = 4;
      
                  for (let i = 0; i < candleCount; i++) {
                        const candleDiv = document.createElement('div');
                        candleDiv.className = 'floating-candle';
      
                        // 添加火焰
                        const flame = document.createElement('div');
                        flame.className = 'candle-flame';
                        flame.textContent = '🔥';
                        candleDiv.appendChild(flame);
      
                        // 添加蜡烛
      
                        const candle = document.createElement('div');
                        candle.textContent = '🕯️';
                        candleDiv.appendChild(candle);
      
                        candleContainer.appendChild(candleDiv);
      
                        // 初始位置和速度
                        const speed = 2;
                        candles.push({
                              element: candleDiv,
                              x: Math.random() * (window.innerWidth - 50),
                              y: Math.random() * (window.innerHeight - 50),
                              dx: (Math.random() - 0.5) * speed,
                              dy: (Math.random() - 0.5) * speed,
                              width: 50,
                              height: 80
                        });
                  }
      
                  // 动画函数
                  function animateCandles() {
                        candles.forEach(candle => {
                              candle.x += candle.dx;
                              candle.y += candle.dy;
      
                              if (candle.x <= 0 || candle.x >= window.innerWidth - candle.width) {
                                    candle.dx *= -1;
                                    candle.dy += (Math.random() - 0.5) * 0.5;
                              }
                              if (candle.y <= 0 || candle.y >= window.innerHeight - candle.height) {
                                    candle.dy *= -1;
                                    candle.dx += (Math.random() - 0.5) * 0.5;
                              }
      
                              const maxSpeed = 3;
                              const speed = Math.sqrt(candle.dx * candle.dx + candle.dy * candle.dy);
                              if (speed > maxSpeed) {
                                    candle.dx = (candle.dx / speed) * maxSpeed;
                                    candle.dy = (candle.dy / speed) * maxSpeed;
                              }
      
                              candle.element.style.transform = `translate(${candle.x}px, ${candle.y}px)`;
                        });
      
      
                        candleAnimationFrame = requestAnimationFrame(animateCandles);
                  }
      
                  animateCandles();
      
                  window.addEventListener('resize', () => {
                        candles.forEach(candle => {
                              candle.x = Math.min(candle.x, window.innerWidth - candle.width);
                              candle.y = Math.min(candle.y, window.innerHeight - candle.height);
                        });
                  });
      
            }
      }
      
      function updateStatus() {
            fetch(API_URL + '/status')
      
                  .then(response => {
                        if (!response.ok) {
                              throw new Error('网络响应不正常: ' + response.statusText);
                        }
                        return response.json();
                  })
                  .then(data => {
                        const statusDiv = document.getElementById('status');
                        const descDiv = document.getElementById('description');
                        const mainBody = document.getElementById('mainBody');
                        console.log('响应数据:', data);
      
                        if (data.sleep !== undefined) {
                              updateUIState(data.sleep);
                        } else {
                              throw new Error('无效的数据格式');
                        }
      
                        document.getElementById('updateTime').textContent = updateTime();
                  })
                  .catch(error => {
                        console.error('获取状态失败:', error);
                        const statusDiv = document.getElementById('status');
                        statusDiv.textContent = '获取状态失败 ❌';
                        statusDiv.className = 'text-2xl my-3 status-error';
                        document.getElementById('description').textContent = error.toString();
                        document.getElementById('updateTime').textContent = updateTime();
                  });
      }
      
      function updateUIState(sleep) {
            const statusDiv = document.getElementById('status');
            const descDiv = document.getElementById('description');
            const mainBody = document.getElementById('mainBody');
      
            if (sleep) {
                  statusDiv.textContent = '似了 😴';
                  statusDiv.className = 'text-2xl my-3 status-sleeping';
                  descDiv.textContent = '目前断网了，除了电话大概都联系不上';
                  mainBody.classList.add('offline-mode');
                  document.documentElement.classList.add('dark');
                  createFloatingElements(true);
            } else {
                  statusDiv.textContent = '活着 🌞';
                  statusDiv.className = 'text-2xl my-3 status-awake';
                  descDiv.textContent = '目前在线，可以通过任何可用的联系方式联系本人。';
                  mainBody.classList.remove('offline-mode');
                  document.documentElement.classList.remove('dark');
                  createFloatingElements(false);
            }
      }
      
      
      function toUTC8DateString(utcTime) {
            const date = new Date(utcTime);
            const utc8 = new Date(date.getTime() + 8 * 60 * 60 * 1000);
            return utc8.toISOString().substring(0, 10); // YYYY-MM-DD
      }
      
      function updateWeeklyStats(records, recentDates) {
            const defaultStats = {
      
                  avgSleepTime: '--:--',
                  avgWakeTime: '--:--',
                  avgSleepDuration: '-小时-分钟',
                  dateRange: '无数据'
            };
      
            // 清空默认值
            if (!records || records.length < 2 || !recentDates || recentDates.length === 0) {
                  Object.entries(defaultStats).forEach(([id, value]) => {
                        document.getElementById(id).textContent = value;
                  });
                  return;
            }
      
            // 按时间排序（旧→新）
      
            const sortedRecords = [...records].sort((a, b) =>
                  new Date(a.time) - new Date(b.time)
            );
      
            const dailySleepData = {};
            let totalSleepMinutes = 0;
            let totalWakeMinutes = 0;
            let primarySleepCount = 0;
            const now = new Date();
      
            // 处理每个睡眠周期
            for (let i = 0; i < sortedRecords.length - 1; i++) {
                  const current = sortedRecords[i];
                  const next = sortedRecords[i + 1];
      
                  if (current.action === 'sleep' && next.action === 'wake') {
                        // 转换为UTC+8时间
                        const sleepTime = new Date(current.time);
                        const wakeTime = new Date(next.time);
      
                        // UTC+8日期处理
                        const sleepDateUTC8 = toUTC8DateString(current.time);
                        const wakeDateUTC8 = toUTC8DateString(next.time);
      
                        // 计算UTC+8的时间数值
                        const sleepUTCHours = sleepTime.getUTCHours() + 8;
                        const sleepHours = (sleepUTCHours >= 24 ? sleepUTCHours - 24 : sleepUTCHours);
                        const sleepStartHours = sleepHours + sleepTime.getUTCMinutes() / 60;
      
      
                        const wakeUTCHours = wakeTime.getUTCHours() + 8;
                        const wakeHours = (wakeUTCHours >= 24 ? wakeUTCHours - 24 : wakeUTCHours);
                        const wakeEndHours = wakeHours + wakeTime.getUTCMinutes() / 60;
      
                        // 获取UTC+8的日期范围
                        const dates = getDatesBetween(sleepTime, wakeTime);
      
                        // 处理每日睡眠分布
                        dates.forEach((dateObj, index) => {
                              const dateKey = dateObj.toISOString().split('T')[0];
      
                              if (!dailySleepData[dateKey]) {
                                    dailySleepData[dateKey] = {
                                          total: 0,
                                          primarySleep: null,
                                          wakeTimes: []
                                    };
                              }
      
      
                              // 计算当天UTC+8时间范围
                              const dayStart = new Date(dateObj);
                              dayStart.setUTCHours(-8, 0, 0, 0); // UTC+8的00:00
                              const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);
      
                              // 计算有效睡眠时间段
                              const effectiveStart = Math.max(sleepTime, dayStart);
                              const effectiveEnd = Math.min(wakeTime, dayEnd);
                              const duration = Math.round((effectiveEnd - effectiveStart) / (60 * 1000));
      
                              if (duration > 0) {
                                    dailySleepData[dateKey].total += duration;
      
                                    // 记录主要睡眠（每天第一个超过3小时的时段）
                                    if (!dailySleepData[dateKey].primarySleep && duration >= 180) {
                                          dailySleepData[dateKey].primarySleep = {
                                                sleepStart: sleepStartHours,
                                                wakeEnd: wakeEndHours,
                                                duration: duration
                                          };
                                    }
                              }
                        });
                  }
            }
      
            // 处理当前进行中的睡眠
      
            const lastRecord = sortedRecords[sortedRecords.length - 1];
            if (lastRecord.action === 'sleep') {
      
                  const sleepTime = new Date(lastRecord.time);
      
                  const dates = getDatesBetween(sleepTime, now);
      
                  dates.forEach(dateObj => {
                        const dateKey = dateObj.toISOString().split('T')[0];
                        if (!dailySleepData[dateKey]) {
                              dailySleepData[dateKey] = {
                                    total: 0,
                                    primarySleep: null,
                                    wakeTimes: []
                              };
                        }
      
                        // UTC+8时间计算
                        const dayStart = new Date(dateObj);
                        dayStart.setUTCHours(-8, 0, 0, 0);
                        const dayEnd = new Date(dayStart.getTime() + 24 * 60 * 60 * 1000);
      
                        const effectiveStart = sleepTime > dayStart ? sleepTime : dayStart;
                        const effectiveEnd = now < dayEnd ? now : dayEnd;
                        const duration = Math.round((effectiveEnd - effectiveStart) / (60 * 1000));
      
                        if (duration > 0) {
                              dailySleepData[dateKey].total += duration;
                        }
                  });
            }
      
            // 计算统计指标
            Object.entries(dailySleepData).forEach(([date, data]) => {
                  if (data.primarySleep) {
                        // UTC+8时间转换
                        totalSleepMinutes += data.primarySleep.sleepStart * 60;
                        totalWakeMinutes += data.primarySleep.wakeEnd * 60;
                        primarySleepCount++;
                  }
            });
      
            // 计算平均值
            const avgSleep = primarySleepCount > 0 ? totalSleepMinutes / primarySleepCount : 0;
            const avgWake = primarySleepCount > 0 ? totalWakeMinutes / primarySleepCount : 0;
      
            // 格式化为UTC+8时间
            const avgSleepTime = primarySleepCount > 0 ?
                  formatTime(avgSleep / 60) :
                  defaultStats.avgSleepTime;
      
            const avgWakeTime = primarySleepCount > 0 ?
                  formatTime(avgWake / 60) :
                  defaultStats.avgWakeTime;
      
            // 计算总睡眠时长
            const totalHours = Object.values(dailySleepData)
                  .reduce((sum, day) => sum + day.total, 0) / 60;
            const avgDaily = recentDates.length > 0 ? totalHours / recentDates.length : 0;
      
            // 更新显示
            document.getElementById('avgSleepTime').textContent = avgSleepTime;
            document.getElementById('avgWakeTime').textContent = avgWakeTime;
      
            document.getElementById('avgSleepDuration').textContent =
                  formatDuration(avgDaily) || defaultStats.avgSleepDuration;
      
            // 日期范围显示（UTC+8）
            if (recentDates.length > 0) {
                  const start = recentDates[recentDates.length - 1].replace(/-/g, '/');
                  const end = recentDates[0].replace(/-/g, '/');
                  document.getElementById('statsDateRange').textContent =
                        `${start} ~ ${end}`;
            } else {
                  document.getElementById('statsDateRange').textContent = defaultStats.dateRange;
            }
      }
      
      function updateSleepTimelines() {
            fetch(API_URL + '/records')
                  .then(response => {
                        if (!response.ok) {
                              throw new Error('网络响应不正常');
                        }
                        return response.json();
                  })
                  .then(data => {
                        if (!data.success || !Array.isArray(data.records)) {
                              throw new Error('无效的数据格式');
                        }
      
      
                        const container = document.getElementById('sleepTimelines');
                        container.innerHTML = '';
      
                        // 处理时间线显示
      
                        const sleepSegments = calculateSleepSegments(data.records);
                        const allDates = Object.keys(sleepSegments).sort().reverse();
      
                        // 找出最近连续的日期（允许最大间隔为3天）
                        const recentContinuousDates = [];
                        const maxDayGap = 3; // 允许的最大日期间隔（天）
      
                        if (allDates.length > 0) {
                              recentContinuousDates.push(allDates[0]);
      
                              for (let i = 1; i < allDates.length; i++) {
                                    const currentDate = new Date(allDates[i]);
                                    const previousDate = new Date(allDates[i - 1]);
      
                                    // 计算日期间隔（天数）
                                    const daysBetween = Math.round(
                                          (previousDate - currentDate) / (24 * 60 * 60 * 1000)
                                    );
      
                                    // 如果日期间隔超过允许的最大间隔，停止收集
                                    if (daysBetween > maxDayGap) {
                                          break;
                                    }
      
                                    recentContinuousDates.push(allDates[i]);
      
                                    // 最多显示7天
                                    if (recentContinuousDates.length >= 7) {
                                          break;
                                    }
                              }
                        }
      
                        // 显示时间线
      
                        recentContinuousDates.forEach(date => {
                              const segments = sleepSegments[date].map(segment => ({
                                    start: segment.start * 100 / 24,
                                    end: segment.end * 100 / 24,
                                    text: `${formatTime(segment.start)}-${formatTime(segment.end)} (${formatDuration(segment.end - segment.start)})`
                              }));
                              const timeline = createTimelineElement(date, segments);
                              container.appendChild(timeline);
                        });
      
                        // 更新统计数据，传入连续日期数组，确保统计与显示的日期范围一致
                        updateWeeklyStats(data.records, recentContinuousDates);
      
                        // 更新时间线标题和描述
      
                        const timelineTitle = document.getElementById('timelineTitle');
                        if (timelineTitle) {
                              if (recentContinuousDates.length === 0) {
                                    timelineTitle.textContent = '离线记录:';
                              } else if (recentContinuousDates.length === 1) {
                                    timelineTitle.textContent = '单日离线记录:';
                              } else {
                                    timelineTitle.textContent = `近${recentContinuousDates.length}天离线记录:`;
                              }
                        }
      
                        // 更新时间线描述
                        if (recentContinuousDates.length === 0) {
                              document.getElementById('timelineDescription').textContent = '暂无离线记录';
                        } else if (recentContinuousDates.length === 1) {
                              document.getElementById('timelineDescription').textContent = `显示 ${recentContinuousDates[0]} 的离线记录`;
                        } else {
                              const oldestDate = recentContinuousDates[recentContinuousDates.length - 1];
                              const newestDate = recentContinuousDates[0];
                              document.getElementById('timelineDescription').textContent =
                                    `显示 ${oldestDate} 至 ${newestDate} 的离线记录`;
                        }
                  })
      
                  .catch(error => {
                        console.error('获取记录失败:', error);
                        document.getElementById('timelineDescription').textContent =
                              '获取记录失败: ' + error.toString();
                  });
      }
      
      document.addEventListener("DOMContentLoaded", () => {
            updateStatus();
            updateSleepTimelines();
      
      
            // 添加测试按钮事件
            const testButton = document.getElementById('testButton');
            let testMode = false;
            testButton.addEventListener('click', () => {
                  testMode = !testMode;
                  updateUIState(testMode);
            });
      });
      
      setInterval(updateStatus, 60000);
      setInterval(updateSleepTimelines, 300000);
    </script>
  </div>
</body>
</html>
