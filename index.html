<!DOCTYPE html>
<html lang="zh-CN" class="dark:bg-gray-900">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”Ÿèšç°åœ¨ä¼¼äº†å—?</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'media',
    }
  </script>
  <style>
    .status-sleeping { color: #3498db; }
    .status-awake { color: #2ecc71; }
    .status-error { color: #e74c3c; }
    @media (prefers-color-scheme: dark) {
      .status-sleeping { color: #60a5fa; }
      .status-awake { color: #34d399; }
      .status-error { color: #f87171; }
    }
    .offline-mode {
      transition: all 0.5s ease;
      filter: grayscale(70%) brightness(85%);
    }
    .floating-candle {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
      font-size: 2rem;
      filter: drop-shadow(0 0 10px rgba(255, 200, 100, 0.3));
      transition: transform 0.3s ease-out;
    }
    .candle-flame {
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      animation: flicker 1s ease-in-out infinite alternate;
      color: #ffd700;
      text-shadow: 0 0 10px #ff6b00,
                   0 0 20px #ff6b00,
                   0 0 30px #ff8800;
    }
    @keyframes flicker {
      0%, 100% { 
        transform: translateX(-50%) scale(1.1);
        text-shadow: 0 0 10px #ff6b00,
                     0 0 20px #ff6b00,
                     0 0 30px #ff8800;
      }
      50% { 
        transform: translateX(-50%) scale(0.9);
        text-shadow: 0 0 5px #ff6b00,
                     0 0 10px #ff6b00,
                     0 0 15px #ff8800;
      }
    }
    .offline-mode::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 50% 50%, rgba(0,0,0,0.3) 0%, transparent 80%),
        linear-gradient(0deg, rgba(0,0,0,0.2) 0%, transparent 100%);
      pointer-events: none;
      z-index: 999;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900" id="mainBody">
  <div id="candleContainer"></div>
  <div class="max-w-2xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 text-gray-900 dark:text-white">ç”Ÿèš<ruby>ä¼¼<rt>sÇ</rt></ruby>äº†å—?</h1>
    
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6 transition-shadow duration-300 hover:shadow-xl">
      <div class="text-gray-700 dark:text-gray-300">shenghuo2's Status:</div>
      <div id="status" class="text-2xl my-3">åŠ è½½ä¸­...</div>
      <div id="description" class="text-gray-600 dark:text-gray-400"></div>
      <div class="text-sm text-gray-500 dark:text-gray-400 mt-4">æœ€åæ›´æ–°: <span id="updateTime"></span></div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6 transition-shadow duration-300 hover:shadow-xl">
      <div id="timelineTitle" class="text-gray-700 dark:text-gray-300 mb-4">ç¦»çº¿è®°å½•:</div>
      <div id="sleepTimelines" class="space-y-8"></div>
      <div id="timelineDescription" class="text-sm text-gray-500 dark:text-gray-400 mt-8"></div>
      <div id="weeklyStats" class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
        <div id="statsTitle" class="text-gray-700 dark:text-gray-300 mb-4">ç¡çœ ç»Ÿè®¡:</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <div class="text-sm text-gray-600 dark:text-gray-400">å¹³å‡å…¥ç¡æ—¶é—´: <span id="avgSleepTime" class="font-mono">--:--</span></div>
            <div class="text-sm text-gray-600 dark:text-gray-400">å¹³å‡æ¸…é†’æ—¶é—´: <span id="avgWakeTime" class="font-mono">--:--</span></div>
          </div>
          <div class="space-y-2">
            <div class="text-sm text-gray-600 dark:text-gray-400">æ¯æ—¥å¹³å‡ç¡çœ æ—¶é•¿: <span id="avgSleepDuration" class="font-mono">-å°æ—¶-åˆ†é’Ÿ</span></div>
            <div class="text-sm text-gray-600 dark:text-gray-400">ç»Ÿè®¡å‘¨æœŸ: <span id="statsDateRange" class="font-mono">----/--/-- ~ ----/--/--</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-col space-y-4">
      <div class="flex justify-between items-center">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªé¡µé¢ ğŸ‘€ shenghuo2
        </div>
        <div class="flex items-center space-x-4">
          <button id="testButton" 
                  class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all duration-300 hover:shadow-lg dark:bg-gray-600 dark:hover:bg-gray-700">
            æµ‹è¯•åˆ‡æ¢æ•ˆæœ
          </button>
          <a href="https://github.com/shenghuo2/sleep-status" 
             target="_blank" 
             class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-300 hover:shadow-lg dark:bg-blue-600 dark:hover:bg-blue-700">
            é¡¹ç›®åœ°å€
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        </div>
      </div>
      <div class="text-xs text-gray-500 dark:text-gray-400 border-t pt-4 mt-4">
        æœ¬é¡¹ç›®å±•ç¤º <a href="https://github.com/shenghuo2" class="text-blue-500 hover:underline" target="_blank">shenghuo2</a> çš„ Xiaomi 14 è®¾å¤‡åœ¨çº¿çŠ¶æ€
        <br>
        æ•°æ®é€šè¿‡ <a href="https://github.com/shenghuo2/sleep-status/tree/feature/magisk-module" class="text-blue-500 hover:underline" target="_blank">Magisk æ¨¡å—</a> å®æ—¶é‡‡é›†å¹¶ä¸Šä¼ 
        <br>
        å‰ç«¯å¼€æºäº <a href="https://github.com/shenghuo2/sleep-status/tree/feature/example-frontend" class="text-blue-500 hover:underline" target="_blank">feature/example-fronend</a> åˆ†æ”¯
      </div>
    </div>

    <script>
      function formatTime(hours) {
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      }

      function formatDuration(hours) {
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        
        if (h === 0) {
          return `${m}m`;
        } else {
          return `${h}h${m > 0 ? m + 'm' : ''}`;
        }
      }

      function updateTime() {
        const now = new Date();
        return now.getFullYear() + '-' + 
               String(now.getMonth() + 1).padStart(2, '0') + '-' + 
               String(now.getDate()).padStart(2, '0') + ' ' + 
               String(now.getHours()).padStart(2, '0') + ':' + 
               String(now.getMinutes()).padStart(2, '0') + ':' + 
               String(now.getSeconds()).padStart(2, '0');
      }

      function createTimelineElement(date, segments) {
        const container = document.createElement('div');
        container.className = 'mb-8 last:mb-0';

        const dateLabel = document.createElement('div');
        dateLabel.className = 'text-sm text-gray-600 dark:text-gray-400 mb-2';
        dateLabel.textContent = date;
        container.appendChild(dateLabel);

        const timelineWrapper = document.createElement('div');
        timelineWrapper.className = 'relative';
        container.appendChild(timelineWrapper);

        // æ—¶é—´çº¿å’Œåˆ»åº¦çº¿
        const timelineContainer = document.createElement('div');
        timelineContainer.className = 'relative h-6 bg-gray-100 dark:bg-gray-700 rounded-md overflow-hidden';
        timelineWrapper.appendChild(timelineContainer);

        // æ·»åŠ åˆ»åº¦çº¿
        for (let hour = 0; hour <= 24; hour += 3) {
          const tick = document.createElement('div');
          tick.className = 'absolute top-0 bottom-0 w-px bg-gray-300 dark:bg-gray-600 z-10';
          tick.style.left = `${(hour / 24) * 100}%`;
          
          // ä¸»è¦åˆ»åº¦çº¿åŠ ç²—
          if (hour % 6 === 0) {
            tick.classList.add('bg-gray-400', 'dark:bg-gray-500');
          }
          
          timelineContainer.appendChild(tick);
        }

        // æ·»åŠ æ—¶é—´åˆ»åº¦
        const timeMarkers = document.createElement('div');
        timeMarkers.className = 'flex justify-between text-xs text-gray-400 dark:text-gray-500 mt-1';
        
        // æ·»åŠ 6å°æ—¶é—´éš”çš„åˆ»åº¦
        for (let hour = 0; hour <= 24; hour += 6) {
          const marker = document.createElement('div');
          marker.className = 'relative';
          marker.style.width = '1px'; // ä»…ç”¨äºå®šä½
          
          // åˆ»åº¦æ–‡æœ¬
          const text = document.createElement('div');
          text.className = 'absolute transform -translate-x-1/2';
          text.textContent = hour === 0 || hour === 24 ? hour : hour;
          marker.appendChild(text);
          
          timeMarkers.appendChild(marker);
        }
        
        timelineWrapper.appendChild(timeMarkers);

        segments.forEach(segment => {
          const segmentElement = document.createElement('div');
          segmentElement.className = 
            'absolute h-full bg-blue-200 dark:bg-blue-800 flex items-center justify-center ' +
            'text-xs text-gray-600 dark:text-gray-300 transition-all duration-300 z-20';
          segmentElement.style.left = segment.start + '%';
          segmentElement.style.width = (segment.end - segment.start) + '%';
          
          const timeText = document.createElement('div');
          timeText.className = 'px-2 whitespace-nowrap';
          timeText.textContent = segment.text;
          segmentElement.appendChild(timeText);
          
          timelineContainer.appendChild(segmentElement);
        });

        return container;
      }

      function calculateSleepSegments(records) {
        const recordsByDate = {};
        records.forEach(record => {
          const date = record.time.split('T')[0];
          if (!recordsByDate[date]) {
            recordsByDate[date] = [];
          }
          recordsByDate[date].push(record);
        });

        const sleepSegments = {};
        for (const [date, dayRecords] of Object.entries(recordsByDate)) {
          sleepSegments[date] = [];
          let lastSleepTime = null;

          dayRecords.sort((a, b) => new Date(a.time) - new Date(b.time));

          dayRecords.forEach(record => {
            const time = new Date(record.time);
            const hours = time.getHours() + time.getMinutes() / 60;

            if (record.action === 'sleep') {
              lastSleepTime = hours;
            } else if (record.action === 'wake' && lastSleepTime !== null) {
              sleepSegments[date].push({
                start: lastSleepTime,
                end: hours
              });
              lastSleepTime = null;
            }
          });

          // å¦‚æœæœ€åä¸€ä¸ªåŠ¨ä½œæ˜¯ç¡çœ ï¼Œä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºç»“æŸæ—¶é—´
          if (lastSleepTime !== null) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            let endHours = 24;
            
            // å¦‚æœæ˜¯ä»Šå¤©çš„è®°å½•ï¼Œä½¿ç”¨å½“å‰æ—¶é—´
            if (date === today) {
              endHours = now.getHours() + now.getMinutes() / 60;
            }
            
            sleepSegments[date].push({
              start: lastSleepTime,
              end: endHours
            });
          }
        }

        return sleepSegments;
      }

      function createFloatingElements(sleep) {
        const candleContainer = document.getElementById('candleContainer');
        let candleAnimationFrame;
        
        // æ¸…é™¤ç°æœ‰çš„å…ƒç´ å’ŒåŠ¨ç”»
        candleContainer.innerHTML = '';
        if (candleAnimationFrame) {
          cancelAnimationFrame(candleAnimationFrame);
        }
        
        if (sleep) {
          // åˆ›å»ºèœ¡çƒ›
          const candles = [];
          const candleCount = 4;
          
          for (let i = 0; i < candleCount; i++) {
            const candleDiv = document.createElement('div');
            candleDiv.className = 'floating-candle';
            
            // æ·»åŠ ç«ç„°
            const flame = document.createElement('div');
            flame.className = 'candle-flame';
            flame.textContent = 'ğŸ”¥';
            candleDiv.appendChild(flame);
            
            // æ·»åŠ èœ¡çƒ›
            const candle = document.createElement('div');
            candle.textContent = 'ğŸ•¯ï¸';
            candleDiv.appendChild(candle);
            
            candleContainer.appendChild(candleDiv);
            
            // åˆå§‹ä½ç½®å’Œé€Ÿåº¦
            const speed = 2;
            candles.push({
              element: candleDiv,
              x: Math.random() * (window.innerWidth - 50),
              y: Math.random() * (window.innerHeight - 50),
              dx: (Math.random() - 0.5) * speed,
              dy: (Math.random() - 0.5) * speed,
              width: 50,
              height: 80
            });
          }

          // åŠ¨ç”»å‡½æ•°
          function animateCandles() {
            candles.forEach(candle => {
              candle.x += candle.dx;
              candle.y += candle.dy;

              if (candle.x <= 0 || candle.x >= window.innerWidth - candle.width) {
                candle.dx *= -1;
                candle.dy += (Math.random() - 0.5) * 0.5;
              }
              if (candle.y <= 0 || candle.y >= window.innerHeight - candle.height) {
                candle.dy *= -1;
                candle.dx += (Math.random() - 0.5) * 0.5;
              }

              const maxSpeed = 3;
              const speed = Math.sqrt(candle.dx * candle.dx + candle.dy * candle.dy);
              if (speed > maxSpeed) {
                candle.dx = (candle.dx / speed) * maxSpeed;
                candle.dy = (candle.dy / speed) * maxSpeed;
              }

              candle.element.style.transform = `translate(${candle.x}px, ${candle.y}px)`;
            });

            candleAnimationFrame = requestAnimationFrame(animateCandles);
          }

          animateCandles();

          window.addEventListener('resize', () => {
            candles.forEach(candle => {
              candle.x = Math.min(candle.x, window.innerWidth - candle.width);
              candle.y = Math.min(candle.y, window.innerHeight - candle.height);
            });
          });
        }
      }

      function updateStatus() {
        fetch('https://sleep-status.shenghuo2.top/status')
          .then(response => {
            if (!response.ok) {
              throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸: ' + response.statusText);
            }
            return response.json();
          })
          .then(data => {
            const statusDiv = document.getElementById('status');
            const descDiv = document.getElementById('description');
            const mainBody = document.getElementById('mainBody');
            console.log('å“åº”æ•°æ®:', data);
            
            if (data.sleep !== undefined) {
              updateUIState(data.sleep);
            } else {
              throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
            }
            
            document.getElementById('updateTime').textContent = updateTime();
          })
          .catch(error => {
            console.error('è·å–çŠ¶æ€å¤±è´¥:', error);
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = 'è·å–çŠ¶æ€å¤±è´¥ âŒ';
            statusDiv.className = 'text-2xl my-3 status-error';
            document.getElementById('description').textContent = error.toString();
            document.getElementById('updateTime').textContent = updateTime();
          });
      }

      function updateUIState(sleep) {
        const statusDiv = document.getElementById('status');
        const descDiv = document.getElementById('description');
        const mainBody = document.getElementById('mainBody');

        if (sleep) {
          statusDiv.textContent = 'ä¼¼äº† ğŸ˜´';
          statusDiv.className = 'text-2xl my-3 status-sleeping';
          descDiv.textContent = 'ç›®å‰æ–­ç½‘äº†ï¼Œé™¤äº†ç”µè¯å¤§æ¦‚éƒ½è”ç³»ä¸ä¸Š';
          mainBody.classList.add('offline-mode');
          document.documentElement.classList.add('dark');
          createFloatingElements(true);
        } else {
          statusDiv.textContent = 'æ´»ç€ ğŸŒ';
          statusDiv.className = 'text-2xl my-3 status-awake';
          descDiv.textContent = 'ç›®å‰åœ¨çº¿ï¼Œå¯ä»¥é€šè¿‡ä»»ä½•å¯ç”¨çš„è”ç³»æ–¹å¼è”ç³»æœ¬äººã€‚';
          mainBody.classList.remove('offline-mode');
          document.documentElement.classList.remove('dark');
          createFloatingElements(false);
        }
      }

      function updateWeeklyStats(records, recentDates) {
        // å¦‚æœæ²¡æœ‰è®°å½•ï¼Œæ˜¾ç¤ºæ— æ•°æ®
        if (!records || records.length < 2 || !recentDates || recentDates.length === 0) {
          document.getElementById('avgSleepTime').textContent = '--:--';
          document.getElementById('avgWakeTime').textContent = '--:--';
          document.getElementById('avgSleepDuration').textContent = '-å°æ—¶-åˆ†é’Ÿ';
          document.getElementById('statsDateRange').textContent = 'æ— æ•°æ®';
          document.getElementById('statsTitle').textContent = 'ç¡çœ ç»Ÿè®¡:';
          return;
        }
        
        // é¦–å…ˆæŒ‰æ—¶é—´æ’åºï¼ˆä»æ–°åˆ°æ—§ï¼‰
        const sortedRecords = [...records].sort((a, b) => new Date(b.time) - new Date(a.time));
        
        // æ‰¾å‡ºæœ€è¿‘çš„ç¡çœ å’Œå”¤é†’å‘¨æœŸ
        const recentCycles = [];
        const now = new Date();
        
        // ä½¿ç”¨æä¾›çš„recentDateså‚æ•°èŒƒå›´å†…çš„æ•°æ®
        const earliestAllowedDate = new Date(recentDates[recentDates.length - 1]);
        earliestAllowedDate.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºå½“å¤©å¼€å§‹æ—¶é—´
        
        const latestAllowedDate = new Date(recentDates[0]);
        latestAllowedDate.setHours(23, 59, 59, 999); // è®¾ç½®ä¸ºå½“å¤©ç»“æŸæ—¶é—´
        
        // æŒ‰æ—¥æœŸåˆ†ç»„å¹¶æ‰¾å‡ºæ¯å¤©çš„ç¡çœ å’Œå”¤é†’æ—¶é—´
        for (let i = 0; i < sortedRecords.length - 1; i++) {
          const current = sortedRecords[i];
          const next = sortedRecords[i + 1];
          
          // å¦‚æœå½“å‰æ˜¯å”¤é†’è®°å½•ï¼Œä¸‹ä¸€ä¸ªæ˜¯ç¡çœ è®°å½•ï¼Œåˆ™è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç¡çœ å‘¨æœŸ
          if (current.action === 'wake' && next.action === 'sleep') {
            const wakeTime = new Date(current.time);
            const sleepTime = new Date(next.time);
            
            // åªå¤„ç†æŒ‡å®šæ—¥æœŸèŒƒå›´å†…çš„æ•°æ®
            if (sleepTime >= earliestAllowedDate && wakeTime <= latestAllowedDate) {
              const currentDate = wakeTime.toISOString().split('T')[0];
              const durationMinutes = (wakeTime - sleepTime) / (60 * 1000); // è½¬æ¢ä¸ºåˆ†é’Ÿ
              
              recentCycles.push({
                sleepTime,
                wakeTime,
                duration: durationMinutes,
                date: currentDate,
                // æ ‡è®°æ˜¯å¦ä¸ºä¸»è¦ç¡çœ ï¼ˆé•¿äº3å°æ—¶ä¸”æ˜¯å½“å¤©ç¬¬ä¸€æ¬¡ç¡çœ ï¼‰
                isPrimarySleep: durationMinutes >= 180 // 3å°æ—¶ = 180åˆ†é’Ÿ
              });
            }
          }
        }
        
        if (recentCycles.length === 0) {
          document.getElementById('avgSleepTime').textContent = '--:--';
          document.getElementById('avgWakeTime').textContent = '--:--';
          document.getElementById('avgSleepDuration').textContent = '-å°æ—¶-åˆ†é’Ÿ';
          document.getElementById('statsDateRange').textContent = 'æ— æ•°æ®';
          document.getElementById('statsTitle').textContent = 'ç¡çœ ç»Ÿè®¡:';
          return;
        }

        // è®¡ç®—ç»Ÿè®¡å‘¨æœŸçš„æ—¥æœŸèŒƒå›´
        let earliestDate = now;
        let latestDate = new Date(0);
        
        recentCycles.forEach(cycle => {
          if (cycle.sleepTime < earliestDate) {
            earliestDate = new Date(cycle.sleepTime);
          }
          if (cycle.wakeTime > latestDate) {
            latestDate = new Date(cycle.wakeTime);
          }
        });

        // æŒ‰æ—¥æœŸåˆ†ç»„ï¼Œæ‰¾å‡ºæ¯å¤©çš„ä¸»è¦ç¡çœ å‘¨æœŸï¼ˆç¬¬ä¸€æ®µé•¿ç¡çœ ï¼‰
        const dailySleepCycles = {};
        
        // é¦–å…ˆæŒ‰æ—¥æœŸåˆ†ç»„æ‰€æœ‰ç¡çœ å‘¨æœŸ
        recentCycles.forEach(cycle => {
          const date = cycle.date;
          if (!dailySleepCycles[date]) {
            dailySleepCycles[date] = [];
          }
          dailySleepCycles[date].push(cycle);
        });
        
        // å¯¹æ¯å¤©çš„ç¡çœ å‘¨æœŸæŒ‰æ—¶é—´æ’åºï¼ˆä»æ—©åˆ°æ™šï¼‰
        Object.keys(dailySleepCycles).forEach(date => {
          dailySleepCycles[date].sort((a, b) => a.sleepTime - b.sleepTime);
          
          // æ ‡è®°æ¯å¤©çš„ç¬¬ä¸€æ®µé•¿ç¡çœ ä¸ºä¸»è¦ç¡çœ 
          let foundPrimary = false;
          dailySleepCycles[date].forEach(cycle => {
            if (!foundPrimary && cycle.duration >= 180) { // 3å°æ—¶ = 180åˆ†é’Ÿ
              cycle.isPrimarySleep = true;
              foundPrimary = true;
            } else {
              cycle.isPrimarySleep = false;
            }
          });
        });
        
        // è®¡ç®—å¹³å‡å€¼
        let totalSleepMinutes = 0;
        let totalWakeMinutes = 0;
        let totalDuration = 0;
        let primarySleepCount = 0;
        
        // è®¡ç®—æ¯æ—¥æ€»ç¡çœ æ—¶é•¿
        const dailyTotalDurations = {};
        
        recentCycles.forEach(cycle => {
          // æ‰€æœ‰ç¡çœ éƒ½è®¡å…¥æ¯æ—¥æ€»ç¡çœ æ—¶é•¿
          const date = cycle.date;
          if (!dailyTotalDurations[date]) {
            dailyTotalDurations[date] = 0;
          }
          dailyTotalDurations[date] += cycle.duration;
          
          // åªæœ‰ä¸»è¦ç¡çœ ï¼ˆé•¿äº3å°æ—¶ä¸”æ˜¯å½“å¤©ç¬¬ä¸€æ¬¡ç¡çœ ï¼‰æ‰è®¡å…¥å…¥ç¡å’Œæ¸…é†’æ—¶é—´
          if (cycle.isPrimarySleep) {
            totalSleepMinutes += cycle.sleepTime.getHours() * 60 + cycle.sleepTime.getMinutes();
            totalWakeMinutes += cycle.wakeTime.getHours() * 60 + cycle.wakeTime.getMinutes();
            primarySleepCount++;
          }
        });
        
        // è®¡ç®—æ¯æ—¥å¹³å‡ç¡çœ æ—¶é•¿
        let totalDailyDuration = 0;
        const daysWithSleep = Object.keys(dailyTotalDurations).length;
        
        Object.values(dailyTotalDurations).forEach(duration => {
          totalDailyDuration += duration;
        });
        
        // è®¡ç®—å¹³å‡å€¼
        const avgSleepMinutes = primarySleepCount > 0 ? Math.round(totalSleepMinutes / primarySleepCount) : 0;
        const avgSleepHour = Math.floor(avgSleepMinutes / 60);
        const avgSleepMinute = avgSleepMinutes % 60;

        const avgWakeMinutes = primarySleepCount > 0 ? Math.round(totalWakeMinutes / primarySleepCount) : 0;
        const avgWakeHour = Math.floor(avgWakeMinutes / 60);
        const avgWakeMinute = avgWakeMinutes % 60;

        const avgDailyDurationMinutes = daysWithSleep > 0 ? Math.round(totalDailyDuration / daysWithSleep) : 0;
        const avgDailyDurationHours = Math.floor(avgDailyDurationMinutes / 60);
        const avgDailyDurationMins = avgDailyDurationMinutes % 60;

        // æ ¼å¼åŒ–æ˜¾ç¤º
        document.getElementById('avgSleepTime').textContent = 
          primarySleepCount > 0 ? `${String(avgSleepHour).padStart(2, '0')}:${String(avgSleepMinute).padStart(2, '0')}` : '--:--';
        
        document.getElementById('avgWakeTime').textContent = 
          primarySleepCount > 0 ? `${String(avgWakeHour).padStart(2, '0')}:${String(avgWakeMinute).padStart(2, '0')}` : '--:--';
        
        document.getElementById('avgSleepDuration').textContent = 
          daysWithSleep > 0 ? (avgDailyDurationHours === 0 ? `${avgDailyDurationMins}m` : `${avgDailyDurationHours}h${avgDailyDurationMins > 0 ? avgDailyDurationMins + 'm' : ''}`) : '-å°æ—¶-åˆ†é’Ÿ';

        // æ˜¾ç¤ºç»Ÿè®¡æ—¶é—´èŒƒå›´
        const dateFormat = date => `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        
        // æ›´æ–°æ ‡é¢˜å’Œç»Ÿè®¡å‘¨æœŸ - ç›´æ¥ä½¿ç”¨recentDatesçš„é•¿åº¦
        const statsTitle = document.getElementById('statsTitle');
        if (statsTitle) {
          // æ ¹æ®recentDatesçš„é•¿åº¦åŠ¨æ€è°ƒæ•´æ ‡é¢˜ï¼Œç¡®ä¿ä¸ç¦»çº¿è®°å½•éƒ¨åˆ†ä¸€è‡´
          if (recentDates.length === 1) {
            statsTitle.textContent = 'å•æ—¥ç»Ÿè®¡:';
          } else {
            statsTitle.textContent = `è¿‘${recentDates.length}å¤©ç»Ÿè®¡:`;
          }
        }
        
        // å¦‚æœåªæœ‰ä¸€å¤©çš„æ•°æ®ï¼Œæ˜¾ç¤ºå…·ä½“æ—¥æœŸè€Œä¸æ˜¯æ—¥æœŸèŒƒå›´
        if (recentDates.length === 1) {
          document.getElementById('statsDateRange').textContent = dateFormat(new Date(recentDates[0]));
        } else {
          document.getElementById('statsDateRange').textContent = 
            `${dateFormat(earliestDate)} ~ ${dateFormat(latestDate)}`;
        }
      }

      function updateSleepTimelines() {
        fetch('https://sleep-status.shenghuo2.top/records')
          .then(response => {
            if (!response.ok) {
              throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
            }
            return response.json();
          })
          .then(data => {
            if (!data.success || !Array.isArray(data.records)) {
              throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
            }

            const container = document.getElementById('sleepTimelines');
            container.innerHTML = '';
            
            // å¤„ç†æ—¶é—´çº¿æ˜¾ç¤º
            const sleepSegments = calculateSleepSegments(data.records);
            const allDates = Object.keys(sleepSegments).sort().reverse();
            
            // æ‰¾å‡ºæœ€è¿‘è¿ç»­çš„æ—¥æœŸï¼ˆå…è®¸æœ€å¤§é—´éš”ä¸º3å¤©ï¼‰
            const recentContinuousDates = [];
            const maxDayGap = 3; // å…è®¸çš„æœ€å¤§æ—¥æœŸé—´éš”ï¼ˆå¤©ï¼‰
            
            if (allDates.length > 0) {
              recentContinuousDates.push(allDates[0]);
              
              for (let i = 1; i < allDates.length; i++) {
                const currentDate = new Date(allDates[i]);
                const previousDate = new Date(allDates[i-1]);
                
                // è®¡ç®—æ—¥æœŸé—´éš”ï¼ˆå¤©æ•°ï¼‰
                const daysBetween = Math.round(
                  (previousDate - currentDate) / (24 * 60 * 60 * 1000)
                );
                
                // å¦‚æœæ—¥æœŸé—´éš”è¶…è¿‡å…è®¸çš„æœ€å¤§é—´éš”ï¼Œåœæ­¢æ”¶é›†
                if (daysBetween > maxDayGap) {
                  break;
                }
                
                recentContinuousDates.push(allDates[i]);
                
                // æœ€å¤šæ˜¾ç¤º7å¤©
                if (recentContinuousDates.length >= 7) {
                  break;
                }
              }
            }
            
            // æ˜¾ç¤ºæ—¶é—´çº¿
            recentContinuousDates.forEach(date => {
              const segments = sleepSegments[date].map(segment => ({
                start: segment.start * 100 / 24,
                end: segment.end * 100 / 24,
                text: `${formatTime(segment.start)}-${formatTime(segment.end)} (${formatDuration(segment.end - segment.start)})`
              }));
              const timeline = createTimelineElement(date, segments);
              container.appendChild(timeline);
            });
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼Œä¼ å…¥è¿ç»­æ—¥æœŸæ•°ç»„ï¼Œç¡®ä¿ç»Ÿè®¡ä¸æ˜¾ç¤ºçš„æ—¥æœŸèŒƒå›´ä¸€è‡´
            updateWeeklyStats(data.records, recentContinuousDates);
            
            // æ›´æ–°æ—¶é—´çº¿æ ‡é¢˜å’Œæè¿°
            const timelineTitle = document.getElementById('timelineTitle');
            if (timelineTitle) {
              if (recentContinuousDates.length === 0) {
                timelineTitle.textContent = 'ç¦»çº¿è®°å½•:';
              } else if (recentContinuousDates.length === 1) {
                timelineTitle.textContent = 'å•æ—¥ç¦»çº¿è®°å½•:';
              } else {
                timelineTitle.textContent = `è¿‘${recentContinuousDates.length}å¤©ç¦»çº¿è®°å½•:`;
              }
            }
            
            // æ›´æ–°æ—¶é—´çº¿æè¿°
            if (recentContinuousDates.length === 0) {
              document.getElementById('timelineDescription').textContent = 'æš‚æ— ç¦»çº¿è®°å½•';
            } else if (recentContinuousDates.length === 1) {
              document.getElementById('timelineDescription').textContent = `æ˜¾ç¤º ${recentContinuousDates[0]} çš„ç¦»çº¿è®°å½•`;
            } else {
              const oldestDate = recentContinuousDates[recentContinuousDates.length - 1];
              const newestDate = recentContinuousDates[0];
              document.getElementById('timelineDescription').textContent = 
                `æ˜¾ç¤º ${oldestDate} è‡³ ${newestDate} çš„ç¦»çº¿è®°å½•`;
            }
          })
          .catch(error => {
            console.error('è·å–è®°å½•å¤±è´¥:', error);
            document.getElementById('timelineDescription').textContent = 
              'è·å–è®°å½•å¤±è´¥: ' + error.toString();
          });
      }

      document.addEventListener("DOMContentLoaded", () => {
        updateStatus();
        updateSleepTimelines();

        // æ·»åŠ æµ‹è¯•æŒ‰é’®äº‹ä»¶
        const testButton = document.getElementById('testButton');
        let testMode = false;
        testButton.addEventListener('click', () => {
          testMode = !testMode;
          updateUIState(testMode);
        });
      });
      
      setInterval(updateStatus, 60000);
      setInterval(updateSleepTimelines, 300000);
    </script>
  </div>
</body>
</html>
